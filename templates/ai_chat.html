{% extends "base.html" %}

{% block title %}AI Chat{% endblock %}

{% block content %}
<style>
    .chat-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .chat-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .chat-messages {
        height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 5px;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
        max-width: 80%;
    }

    .user-message {
        background-color: rgba(100, 149, 237, 0.3);
        margin-left: auto;
        text-align: right;
    }

    .ai-message {
        background-color: rgba(144, 238, 144, 0.3);
        margin-right: auto;
    }

    .message-input {
        display: flex;
        gap: 10px;
    }

    .message-input input {
        flex: 1;
        padding: 10px;
    }

    .code-block {
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        overflow-x: auto;
        font-family: monospace;
        white-space: pre;
    }
</style>

<div class="chat-container rpgui-container framed-golden">
    <div class="chat-header">
        <h2>ðŸ¤– AI Code Generator Chat</h2>
        <p>PregÃºntame sobre cÃ³digo y te ayudarÃ© a generarlo</p>
    </div>

    <div id="chatMessages" class="chat-messages rpgui-container framed">
        <div class="message ai-message">
            <p>Â¡Hola! Soy tu asistente de cÃ³digo. Â¿En quÃ© puedo ayudarte hoy?</p>
        </div>
    </div>

    <form id="chatForm" class="message-input">
        <input type="text" id="userMessage" class="rpgui-input" placeholder="Escribe tu mensaje aquÃ­..." required>
        <button type="submit" class="rpgui-button">Enviar</button>
    </form>
</div>

<script>
    document.getElementById('chatForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const userInput = document.getElementById('userMessage').value.trim();
        if (!userInput) return;
        
        // Add user message to chat
        addMessage(userInput, 'user');
        
        // Clear input field
        document.getElementById('userMessage').value = '';
        
        try {
            // Send request to backend
            const response = await fetch('/api/ai-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: userInput }),
            });
            
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            
            const data = await response.json();
            
            // Add AI response to chat
            addMessage(data.response, 'ai');
            
        } catch (error) {
            console.error('Error:', error);
            addMessage('Lo siento, ha ocurrido un error al procesar tu solicitud.', 'ai');
        }
    });
    
    function addMessage(text, sender) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
        
        // Check if the message contains code (simple detection)
        if (sender === 'ai' && (text.includes('```') || text.includes('function') || text.includes('class') || text.includes('def '))) {
            const parts = text.split('```');
            
            for (let i = 0; i < parts.length; i++) {
                if (i % 2 === 0) {
                    // Regular text
                    if (parts[i].trim()) {
                        const p = document.createElement('p');
                        p.textContent = parts[i].trim();
                        messageDiv.appendChild(p);
                    }
                } else {
                    // Code block
                    const codeBlock = document.createElement('div');
                    codeBlock.className = 'code-block';
                    codeBlock.textContent = parts[i].trim();
                    messageDiv.appendChild(codeBlock);
                }
            }
        } else {
            const p = document.createElement('p');
            p.textContent = text;
            messageDiv.appendChild(p);
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
{% endblock %}