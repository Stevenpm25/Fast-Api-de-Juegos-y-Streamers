{% extends 'base.html' %}
{% block title %}CRUD de Streamers{% endblock %}

{% block content %}
<style>
.page-layout {
    display: flex;
    gap: 2em;
    align-items: flex-start;
    height: calc(100vh - 150px); /* Adjusted height to match games list view */
    overflow: hidden; /* Prevent overflow */
}

.buttons-container {
    position: sticky;
    top: 20px;
    width: 300px;
    max-height: calc(100vh - 150px);
    overflow-y: auto;
}

.forms-container {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    height: 100%;
    overflow-y: auto; /* Ensure independent scrolling */
    padding-right: 1em;
    max-width: 100%;
}

.info-container {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 15px;
    padding: 20px;
}

.crud-buttons {
    position: sticky;
    top: 0;
    padding: 15px;
}

.button-row {
    display: flex;
    flex-direction: column;
    gap: 0.8em;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    padding-right: 10px;
}

.button-row .rpgui-button {
    width: 100%;
    padding: 0.6em 1.2em !important; /* Match padding with games CRUD */
    font-size: 0.9em; /* Adjust font size for consistency */
    min-height: unset !important;
}

.button-row::-webkit-scrollbar {
    width: 8px;
}

.button-row::-webkit-scrollbar-track {
    background: rgba(0, 255, 0, 0.1);
    border-radius: 10px;
}

.button-row::-webkit-scrollbar-thumb {
    background: rgba(0, 255, 0, 0.3);
    border-radius: 10px;
    border: 2px solid rgba(0, 255, 0, 0.1);
}

.button-row::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 255, 0, 0.5);
}

.operation-form {
    margin-bottom: 0.5em;
    padding: 0.5em;
}

.form-group {
    margin-bottom: 0.8em;
    display: grid;
    grid-template-columns: 150px 1fr;
    align-items: center;
    gap: 0.5em;
}

.form-group label {
    font-size: 0.9em;
}

.form-group input {
    width: 100%;
    padding: 0.4em;
}

.form-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.8em;
    margin-top: 1em;
}

.form-buttons .rpgui-button {
    padding: 0.5em 1em !important;
    min-height: unset !important;
}

h2, h3 {
    text-align: center;
    margin-bottom: 0.8em;
    font-size: 1.1em;
}

.message {
    padding: 0.8em;
    margin-bottom: 1em;
    border-radius: 4px;
}

.success { background-color: rgba(0, 255, 0, 0.1); color: #00ff00; }
.error { background-color: rgba(255, 0, 0, 0.1); color: #ff0000; }

@media (max-width: 768px) {
    .page-layout {
        grid-template-columns: 1fr;
        height: auto;
        overflow: visible;
    }

    .forms-container {
        height: auto;
        overflow: visible;
    }

    .form-group {
        grid-template-columns: 1fr;
    }

    .form-buttons {
        flex-direction: column;
    }

    .form-buttons .rpgui-button {
        width: 100%;
    }
}

.table-wrapper {
    max-height: 200px !important;
    overflow-y: auto;
    margin: 0.3em 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.table-container {
    width: 100%;
}

.table-container table {
    width: 100%;
    border-collapse: collapse;
}

.table-container th {
    position: sticky;
    top: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 1;
    padding: 4px 6px !important;
    text-align: left;
    font-size: 0.85em !important;
    line-height: 1.2 !important;
}

.table-container td {
    padding: 2px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.table-container tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.table-wrapper::-webkit-scrollbar {
    width: 12px;
}

.table-wrapper::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
}

.table-wrapper::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    border: 3px solid rgba(0, 0, 0, 0.3);
}

.table-wrapper::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.3);
}

/* Estilo personalizado para la barra de scroll */
::-webkit-scrollbar {
    width: 12px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 255, 0, 0.1);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: rgba(0, 255, 0, 0.3);
    border-radius: 10px;
    border: 2px solid rgba(0, 255, 0, 0.1);
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 255, 0, 0.5);
}

.form-scroll {
    max-height: 400px;
    overflow-y: auto;
}

/* Ajustar el espaciado interno y alineaci√≥n de las celdas */
.table-wrapper td, .table-wrapper th {
    padding: 14px 20px; /* M√°s espacio interno */
    text-align: center; /* Centrar el contenido */
}

.table-wrapper tr {
    height: 60px; /* Aumentar la altura de las filas */
}
/* Ajustar el espaciado interno y alineaci√≥n de las celdas */
.table-wrapper td, .table-wrapper th {
    padding: 14px 20px; /* M√°s espacio interno */
    text-align: center; /* Centrar el contenido */
}

.table-wrapper tr {
    height: 60px; /* Aumentar la altura de las filas */
}

td {
    padding: 4px 6px !important;
    font-size: 0.85em !important;
    line-height: 1.2 !important;
}

th {
    padding: 4px 6px !important;
    font-size: 0.85em !important;
    line-height: 1.2 !important;
}

img {
    width: 25px !important;
    height: 25px !important;
}
</style>

<div class="page-layout" style="display: flex; gap: 2em; align-items: flex-start;">
  <!-- Columna izquierda: Botones -->
  <div class="buttons-container">
    <div class="crud-buttons rpgui-container framed-golden">
      <h2>üë§ Opciones</h2>
      <div class="button-row">
        <button class="rpgui-button" onclick="showCreateForm()"><span>‚ûï Crear</span></button>
        <button class="rpgui-button" onclick="showDeleteForm()"><span>üóëÔ∏è Eliminar</span></button>
        <button class="rpgui-button" onclick="showUpdateForm()"><span>‚úèÔ∏è Actualizar</span></button>
        <button class="rpgui-button" onclick="showSearchById()"><span>üîç Buscar ID</span></button>
        <button class="rpgui-button" onclick="showSearchByName()"><span>üîé Buscar Nombre</span></button>
        <button class="rpgui-button" onclick="showImportForm()"><span>üì• Importar</span></button>
        <button class="rpgui-button" onclick="showDeletedStreamers()"><span>üóëÔ∏èüëÄ Mostrar Eliminados</span></button>
        <button class="rpgui-button" onclick="showPartialUpdateForm()"><span>üîß Actualizaci√≥n Parcial</span></button>
        <button class="rpgui-button" onclick="showRestoreForm()"><span>‚ôªÔ∏è Recuperar Eliminado</span></button>
        <button class="rpgui-button" onclick="showStreamersList()"><span>üìã Listar</span></button>
      </div>
    </div>
  </div>

  <!-- Columna derecha: Formularios y contenido -->
  <div style="display: flex; flex-direction: column; gap: 2em; flex: 1; max-height: calc(100vh - 100px); overflow: hidden;">
    <!-- Contenedor de formularios con scroll independiente -->
    <div class="forms-container" style="flex: 1; overflow-y: auto;">
      {% if success_msg %}
      <div class="message success">{{ success_msg }}</div>
      {% endif %}
      {% if error_msg %}
      <div class="message error">{{ error_msg }}</div>
      {% endif %}

      <!-- Formulario de creaci√≥n -->
      <div id="createForm" class="operation-form rpgui-container framed-golden form-scroll" style="display: none;">
          <h3>‚ûï Crear Nuevo Streamer</h3>
          <form onsubmit="createStreamer(event)" enctype="multipart/form-data">
              <div class="form-group">
                  <label class="rpgui-label">üë§ Nombre:</label>
                  <input type="text" id="createStreamerName" class="rpgui-input" required minlength="2" maxlength="100">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üéÆ Juego:</label>
                  <input type="text" id="createStreamerGame" class="rpgui-input" required minlength="2" maxlength="100">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üë• Seguidores:</label>
                  <input type="number" id="createStreamerFollowers" class="rpgui-input" min="0" required>
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üëÄ Espectadores Promedio:</label>
                  <input type="number" id="createStreamerAvgViewers" class="rpgui-input" min="0" required>
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üì∏ Imagen del Streamer:</label>
                  <input type="file" id="createStreamerImage" class="rpgui-input" accept="image/*">
              </div>
              <div class="form-buttons">
                  <button type="submit" class="rpgui-button">üíæ Guardar</button>
              </div>
          </form>
      </div>

      <!-- Formulario de Eliminaci√≥n -->
      <div id="deleteForm" class="operation-form rpgui-container framed-golden" style="display: none;">
          <h3>üóëÔ∏è Eliminar Streamer</h3>
          <form onsubmit="deleteStreamer(event)">
              <div class="form-group">
                  <label class="rpgui-label">üî¢ ID del Streamer:</label>
                  <input type="number" id="deleteStreamerId" class="rpgui-input" required min="1">
              </div>
              <div class="form-buttons">
                  <button type="submit" class="rpgui-button">
                      <span>üóëÔ∏è Eliminar</span>
                  </button>
                  <button type="button" class="rpgui-button" onclick="hideAllForms()">
                      <span>‚ùå Cancelar</span>
                  </button>
              </div>
          </form>
      </div>

      <!-- Formulario de Recuperaci√≥n -->
      <div id="restoreForm" class="operation-form rpgui-container framed-golden" style="display: none;">
          <h3>‚ôªÔ∏è Recuperar Streamer Eliminado</h3>
          <form onsubmit="restoreStreamer(event)">
              <div class="form-group">
                  <label class="rpgui-label">üî¢ ID del Streamer:</label>
                  <input type="number" id="restoreStreamerId" class="rpgui-input" required min="1">
              </div>
              <div class="form-buttons">
                  <button type="submit" class="rpgui-button">
                      <span>‚ôªÔ∏è Recuperar</span>
                  </button>
                  <button type="button" class="rpgui-button" onclick="hideAllForms()">
                      <span>‚ùå Cancelar</span>
                  </button>
              </div>
          </form>
      </div>

      <!-- Formulario de B√∫squeda por ID -->
      <div id="searchByIdForm" class="operation-form rpgui-container framed-golden form-scroll" style="display: none;">
          <h3>üîç Buscar Streamer por ID</h3>
          <form onsubmit="buscarPorId(event)">
              <div class="form-group">
                  <label class="rpgui-label">üî¢ ID del Streamer:</label>
                  <input type="number" id="buscarStreamerId" class="rpgui-input" min="1" required>
              </div>
              <div class="form-buttons">
                  <button type="submit" class="rpgui-button">
                      <span>üîç Buscar</span>
                  </button>
                  <button type="button" class="rpgui-button" onclick="hideAllForms()">
                      <span>‚ùå Cancelar</span>
                  </button>
              </div>
          </form>

          <!-- Contenedor para mostrar el resultado -->
          <div id="searchIdResult" style="display: none; margin-top: 20px;">
              <h3>üìã Resultado:</h3>
              <div class="table-wrapper" style="background: none; border: none;">
                  <div style="overflow-x:auto;">
                  <table style="min-width: 600px; max-width: 100%; margin: 0 auto; border-collapse: separate; border-spacing: 0 10px;">
                      <thead>
                          <tr>
                              <th style="padding: 12px 18px; text-align:center;">ID</th>
                              <th style="padding: 12px 18px; text-align:center;">Imagen</th>
                              <th style="padding: 12px 18px; text-align:center;">Nombre</th>
                              <th style="padding: 12px 18px; text-align:center;">Juego</th>
                              <th style="padding: 12px 18px; text-align:center;">Seguidores</th>
                              <th style="padding: 12px 18px; text-align:center;">Espectadores Promedio</th>
                          </tr>
                      </thead>
                      <tbody id="searchIdResultsBody" style="font-size: 1.08em;">
                      </tbody>
                  </table>
                  </div>
              </div>
          </div>
      </div>

      <!-- Formulario de B√∫squeda por Nombre -->
      <div id="searchByNameForm" class="operation-form rpgui-container framed-golden form-scroll" style="display: none;">
          <h3>üîé Buscar Streamer por Nombre</h3>
          <form onsubmit="buscarPorNombre(event)">
              <div class="form-group">
                  <label class="rpgui-label">üë§ Nombre del Streamer:</label>
                  <input type="text" id="buscarStreamerName" class="rpgui-input" required minlength="1" placeholder="Ingresa al menos un car√°cter">
              </div>
              <div class="form-buttons">
                  <button type="submit" class="rpgui-button">
                      <span>üîé Buscar</span>
                  </button>
                  <button type="button" class="rpgui-button" onclick="hideAllForms()">
                      <span>‚ùå Cancelar</span>
                  </button>
              </div>
          </form>

          <!-- Contenedor para mostrar los resultados -->
          <div id="searchNameResult" style="display: none;">
              <h3>üìã Resultados:</h3>
              <div class="table-wrapper" style="background: none; border: none;">
                  <table style="min-width: 600px; max-width: 100%; margin: 0 auto; border-collapse: separate; border-spacing: 0 10px;">
                      <thead>
                          <tr>
                              <th style="padding: 12px 18px; text-align:center;">ID</th>
                              <th style="padding: 12px 18px; text-align:center;">Imagen</th>
                              <th style="padding: 12px 18px; text-align:center;">Nombre</th>
                              <th style="padding: 12px 18px; text-align:center;">Juego</th>
                              <th style="padding: 12px 18px; text-align:center;">Seguidores</th>
                              <th style="padding: 12px 18px; text-align:center;">Espectadores Promedio</th>
                          </tr>
                      </thead>
                      <tbody id="searchNameResultsBody" style="font-size: 1.08em;">
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- Formulario de Importaci√≥n de CSV -->
      <div id="importForm" class="operation-form rpgui-container framed-golden" style="display: none;">
          <h3>üì• Importar Streamers desde CSV</h3>
          <form onsubmit="importStreamers(event)">
              <div class="form-group">
                  <label class="rpgui-label">üìÅ Archivo CSV:</label>
                  <input type="file" id="importFile" class="rpgui-input" accept=".csv" required>
                  <p style="font-size: 0.8em; margin-top: 0.5em; color: #aaa;">
                      El archivo CSV debe contener las columnas: name, game, follower_count, avg_viewers
                  </p>
              </div>
              <div class="form-buttons">
                  <button type="submit" class="rpgui-button">
                      <span>üì• Importar</span>
                  </button>
                  <button type="button" class="rpgui-button" onclick="hideAllForms()">
                      <span>‚ùå Cancelar</span>
                  </button>
              </div>
          </form>
      </div>

      <!-- Formulario de Actualizaci√≥n Parcial -->
      <div id="partialUpdateForm" class="operation-form rpgui-container framed-golden form-scroll" style="display: none;">
          <h3>‚úèÔ∏èüîß Actualizaci√≥n Parcial</h3>
          <form onsubmit="partialUpdateStreamer(event)" enctype="multipart/form-data">
              <div class="form-group">
                  <label class="rpgui-label">üî¢ ID del Streamer:</label>
                  <input type="number" id="partialUpdateStreamerId" class="rpgui-input" required min="1">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üë§ Nombre:</label>
                  <input type="text" id="partialUpdateName" class="rpgui-input" minlength="2" maxlength="100">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üéÆ Juego:</label>
                  <input type="text" id="partialUpdateGame" class="rpgui-input" minlength="2" maxlength="100">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üë• Seguidores:</label>
                  <input type="number" id="partialUpdateFollowers" class="rpgui-input" min="0">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üëÄ Espectadores Promedio:</label>
                  <input type="number" id="partialUpdateAvgViewers" class="rpgui-input" min="0">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üì∏ Nueva Imagen:</label>
                  <input type="file" id="partialUpdateImage" class="rpgui-input" accept="image/*">
                  <div class="checkbox-wrapper" style="margin-top: 10px; display: none;">
                      <input type="checkbox" id="sendEmptyImage" class="rpgui-checkbox">
                      <label for="sendEmptyImage" class="rpgui-label">Marca esta opci√≥n si deseas agregar una imagen</label>
                  </div>
              </div>
              <div class="form-buttons">
                  <button type="submit" class="rpgui-button">
                      <span>üíæ Guardar</span>
                  </button>
                  <button type="button" class="rpgui-button" onclick="hideAllForms()">
                      <span>‚ùå Cancelar</span>
                  </button>
              </div>
          </form>
      </div>

      <!-- Formulario de Actualizaci√≥n -->
      <div id="updateForm" class="operation-form rpgui-container framed-golden form-scroll" style="display: none;">
          <h3>‚úèÔ∏è Actualizar Streamer</h3>
          <form onsubmit="updateStreamer(event)" enctype="multipart/form-data">
              <div class="form-group">
                  <label class="rpgui-label">üî¢ ID del Streamer:</label>
                  <input type="number" id="updateStreamerId" class="rpgui-input" required min="1">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üë§ Nombre:</label>
                  <input type="text" id="updateStreamerName" class="rpgui-input" required minlength="2" maxlength="100">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üéÆ Juego:</label>
                  <input type="text" id="updateStreamerGame" class="rpgui-input" required minlength="2" maxlength="100">
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üë• Seguidores:</label>
                  <input type="number" id="updateStreamerFollowers" class="rpgui-input" min="0" required>
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üëÄ Espectadores Promedio:</label>
                  <input type="number" id="updateStreamerAvgViewers" class="rpgui-input" min="0" required>
              </div>
              <div class="form-group">
                  <label class="rpgui-label">üì∏ Nueva Imagen:</label>
                  <input type="file" id="updateStreamerImage" class="rpgui-input" accept="image/*">
              </div>
              <div class="form-buttons">
                  <button type="submit" class="rpgui-button">
                      <span>üíæ Guardar</span>
                  </button>
                  <button type="button" class="rpgui-button" onclick="hideAllForms()">
                      <span>‚ùå Cancelar</span>
                  </button>
              </div>
          </form>
      </div>

      <!-- Listar todos los streamers -->
      <div id="listForm" class="operation-form rpgui-container framed-golden" style="display: none;">
          <h3 style="margin-bottom: 0.2em; font-size: 0.95em;">üìã Lista de Streamers</h3>
          <div class="table-wrapper" style="max-height: 200px; overflow-y: auto;">
              <table>
                  <thead>
                      <tr>
                          <th style="padding: 4px 6px;">ID</th>
                          <th style="padding: 4px 6px;">Imagen</th>
                          <th style="padding: 4px 6px;">Nombre</th>
                          <th style="padding: 4px 6px;">Juego</th>
                          <th style="padding: 4px 6px;">Seguidores</th>
                          <th style="padding: 4px 6px;">Espectadores Promedio</th>
                      </tr>
                  </thead>
                  <tbody id="listStreamersBody">
                      <!-- Las filas se insertan por JS -->
                  </tbody>
              </table>
          </div>
      </div>
    </div>

    <!-- Contenedor de informaci√≥n con scroll independiente -->
    <div class="info-container" style="flex: 1; overflow-y: auto;">
      {% include 'info_streamers.html' %}
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
function hideAllForms() {
    // Ocultar todos los formularios
    document.querySelectorAll('.operation-form').forEach(form => {
        form.style.display = 'none';
    });

    // Ocultar la informaci√≥n de streamers
    const infoContainer = document.querySelector('.info-container');
    if (infoContainer) {
        infoContainer.style.display = 'none';
    }

    // Limpiar la lista de streamers
    const streamersList = document.getElementById('streamersList');
    if (streamersList) {
        streamersList.innerHTML = '';
    }

    // Limpiar mensajes
    document.querySelectorAll('.message').forEach(msg => {
        msg.style.display = 'none';
    });
}

function showCreateForm() {
    hideAllForms();
    document.getElementById('createForm').style.display = 'block';
}

function showDeleteForm() {
    hideAllForms();
    document.getElementById('deleteForm').style.display = 'block';
}

function showUpdateForm() {
    hideAllForms();
    document.getElementById('updateForm').style.display = 'block';
}

function showSearchById() {
    hideAllForms();
    document.getElementById('searchByIdForm').style.display = 'block';
}

function showSearchByName() {
    hideAllForms();
    document.getElementById('searchByNameForm').style.display = 'block';
}

function showImportForm() {
    hideAllForms();
    document.getElementById('importForm').style.display = 'block';
}

function showDeletedStreamers() {
    hideAllForms();
    document.getElementById('deletedStreamersSection').style.display = 'block';
    loadDeletedStreamers();
}

function showPartialUpdateForm() {
    hideAllForms();
    document.getElementById('partialUpdateForm').style.display = 'block';
}

function showRestoreForm() {
    hideAllForms();
    document.getElementById('restoreForm').style.display = 'block';
}

function showStreamersList() {
    hideAllForms();
    // Mostrar la informaci√≥n de streamers nuevamente
    const infoContainer = document.querySelector('.info-container');
    if (infoContainer) {
        infoContainer.style.display = 'block';
    }
    loadStreamers();
}

// Crear streamer
async function createStreamer(event) {
    event.preventDefault();
    const formData = new FormData();
    formData.append('name', document.getElementById('createStreamerName').value);
    formData.append('game', document.getElementById('createStreamerGame').value);
    formData.append('follower_count', document.getElementById('createStreamerFollowers').value);
    formData.append('avg_viewers', document.getElementById('createStreamerAvgViewers').value);

    const imageInput = document.getElementById('createStreamerImage');
    if (imageInput.files.length > 0) {
        formData.append('image', imageInput.files[0]);
    }

    try {
        const response = await fetch('/api/streamers', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert('¬°Streamer creado correctamente!');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al crear el streamer: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al crear el streamer');
    }
}

// Actualizar streamer
async function updateStreamer(event) {
    event.preventDefault();
    const streamerId = document.getElementById('updateStreamerId').value;
    const formData = new FormData();

    formData.append('name', document.getElementById('updateStreamerName').value);
    formData.append('game', document.getElementById('updateStreamerGame').value);
    formData.append('follower_count', document.getElementById('updateStreamerFollowers').value);
    formData.append('avg_viewers', document.getElementById('updateStreamerAvgViewers').value);

    const imageInput = document.getElementById('updateStreamerImage');
    if (imageInput.files.length > 0) {
        formData.append('image', imageInput.files[0]);
    }

    try {
        const response = await fetch(`/api/streamers/${streamerId}`, {
            method: 'PUT',
            body: formData
        });

        if (response.ok) {
            alert(`¬°Streamer con ID ${streamerId} actualizado correctamente!`);
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al actualizar el streamer: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el streamer');
    }
}

// Eliminar streamer
async function deleteStreamer(event) {
    event.preventDefault();
    const streamerId = document.getElementById('deleteStreamerId').value;

    if (confirm('¬øEst√°s seguro de que deseas eliminar este streamer?')) {
        try {
            const response = await fetch(`/api/streamers/${streamerId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('¬°Streamer eliminado correctamente!');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error al eliminar el streamer: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al eliminar el streamer');
        }
    }
}

// Recuperar streamer
async function restoreStreamer(event) {
    event.preventDefault();
    const streamerId = document.getElementById('restoreStreamerId').value;

    if (confirm('¬øEst√°s seguro de que deseas recuperar este streamer eliminado?')) {
        try {
            const response = await fetch(`/api/streamers/recover/${streamerId}`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('¬°Streamer recuperado correctamente!');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error al recuperar el streamer: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al recuperar el streamer');
        }
    }
}

// B√∫squeda por ID
async function buscarPorId(event) {
    event.preventDefault();
    const id = document.getElementById('buscarStreamerId').value;

    try {
        const response = await fetch(`/api/streamers/${id}`);
        const tbody = document.getElementById('searchIdResultsBody');
        tbody.innerHTML = '';

        if (response.ok) {
            const streamer = await response.json();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.id}</td>
                <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">
                    ${streamer.image_url ?
                        `<a href="${streamer.image_url}" target="_blank">
                            <img src="${streamer.image_url}" alt="${streamer.name}"
                                 style="width: 48px; height: 48px; object-fit: cover; border-radius: 50%; margin: 0 auto; display: block;">
                        </a>` :
                        '‚ùå Sin imagen'
                    }
                </td>
                <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.name}</td>
                <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.game}</td>
                <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.follower_count.toLocaleString()}</td>
                <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.avg_viewers.toLocaleString()}</td>
            `;
            tbody.appendChild(row);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 14px;">
                        No se encontr√≥ ning√∫n streamer con el ID <b>${id}</b>
                    </td>
                </tr>`;
        }

        document.getElementById('searchIdResult').style.display = 'block';
    } catch (error) {
        console.error(error);
        alert('Hubo un error al realizar la b√∫squeda');
    }
}

async function buscarPorNombre(event) {
    event.preventDefault();
    const nombre = document.getElementById('buscarStreamerName').value;

    try {
        const response = await fetch(`/api/streamers/search?name=${encodeURIComponent(nombre)}`);
        const tbody = document.getElementById('searchNameResultsBody');
        tbody.innerHTML = '';

        if (response.ok) {
            const streamers = await response.json();

            if (streamers.length > 0) {
                streamers.forEach(streamer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.id}</td>
                        <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">
                            ${streamer.image_url ?
                                `<a href="${streamer.image_url}" target="_blank">
                                    <img src="${streamer.image_url}" alt="${streamer.name}"
                                         style="width: 48px; height: 48px; object-fit: cover; border-radius: 50%; margin: 0 auto; display: block;">
                                </a>` :
                                '‚ùå Sin imagen'
                            }
                        </td>
                        <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.name}</td>
                        <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.game}</td>
                        <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.follower_count.toLocaleString()}</td>
                        <td style="padding: 14px 18px; text-align: center; vertical-align: middle;">${streamer.avg_viewers.toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 14px;">
                            No se encontraron streamers con el nombre "${nombre}"
                        </td>
                    </tr>`;
            }
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 14px;">
                        Nombre no encontrado: "${nombre}"
                    </td>
                </tr>`;
        }

        document.getElementById('searchNameResult').style.display = 'block';
    } catch (error) {
        console.error(error);
        alert('Hubo un error al realizar la b√∫squeda');
    }
}

// Importar streamers desde CSV
async function importStreamers(event) {
    event.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('importFile');
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/streamers/import', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert('Streamers importados correctamente');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al importar los streamers: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al importar los streamers');
    }
}

// Actualizaci√≥n parcial
async function partialUpdateStreamer(event) {
    event.preventDefault();
    const streamerId = document.getElementById('partialUpdateStreamerId').value;
    const formData = new FormData();

    // Campos opcionales - solo agregar si tienen valor
    const name = document.getElementById('partialUpdateName').value;
    const game = document.getElementById('partialUpdateGame').value;
    const followerCount = document.getElementById('partialUpdateFollowers').value;
    const avgViewers = document.getElementById('partialUpdateAvgViewers').value;

    if (name) formData.append('name', name);
    if (game) formData.append('game', game);
    if (followerCount) formData.append('follower_count', followerCount);
    if (avgViewers) formData.append('avg_viewers', avgViewers);

    // Manejar la imagen
    const imageInput = document.getElementById('partialUpdateImage');
    const sendEmptyImage = document.getElementById('sendEmptyImage').checked;

    if (sendEmptyImage) {
        // Si se marca la opci√≥n de enviar valor vac√≠o, enviar un string vac√≠o
        formData.append('image', '');
    } else if (imageInput.files.length > 0) {
        // Si se seleccion√≥ una imagen, enviarla
        formData.append('image', imageInput.files[0]);
    }

    try {
        const response = await fetch(`/api/streamers/partial-update/${streamerId}`, {
            method: 'PATCH',
            body: formData
        });

        if (response.ok) {
            alert('¬°Streamer actualizado correctamente!');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al actualizar el streamer: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el streamer');
    }
}

// Mostrar streamers eliminados
async function showDeletedStreamers() {
    try {
        const response = await fetch('/api/streamers/deleted');
        if (response.ok) {
            const deletedStreamers = await response.json();
            hideAllForms();

            if (deletedStreamers.length === 0) {
                alert('No hay streamers eliminados para mostrar');
                return;
            }

            const tableHTML = `
                <div id="deletedStreamersForm" class="operation-form rpgui-container framed-golden">
                    <h3>üóëÔ∏èüëÄ Streamers Eliminados</h3>
                    <div class="table-wrapper rpgui-container framed">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Imagen</th>
                                    <th>Nombre</th>
                                    <th>Juego</th>
                                    <th>Seguidores</th>
                                    <th>Espectadores Promedio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${deletedStreamers.map(streamer => `
                                    <tr>
                                        <td>${streamer.id}</td>
                                        <td>
                                            ${streamer.image_url ?
                                                `<img src="${streamer.image_url}" alt="${streamer.name}" style="width: 50px; height: 50px; object-fit: cover;">` :
                                                '‚ùå Sin imagen'
                                            }
                                        </td>
                                        <td>${streamer.name}</td>
                                        <td>${streamer.game}</td>
                                        <td>${parseInt(streamer.follower_count).toLocaleString()}</td>
                                        <td>${parseInt(streamer.avg_viewers).toLocaleString()}</td>
                                        <td>
                                            <button class="rpgui-button" onclick="recoverStreamer(${streamer.id})">
                                                <span>‚ôªÔ∏è Recuperar</span>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const formsContainer = document.querySelector('.forms-container');
            const existingList = document.getElementById('deletedStreamersForm');
            if (existingList) existingList.remove();

            formsContainer.insertAdjacentHTML('beforeend', tableHTML);
            document.getElementById('deletedStreamersForm').style.display = 'block';
        } else {
            alert('Error al cargar los streamers eliminados');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar los streamers eliminados');
    }
}

// Recuperar streamer eliminado
async function recoverStreamer(streamerId) {
    if (confirm(`¬øRecuperar el streamer con ID ${streamerId}?`)) {
        try {
            const response = await fetch(`/api/streamers/recover/${streamerId}`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('¬°Streamer recuperado correctamente!');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error al recuperar: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al recuperar el streamer');
        }
    }
}

// Listar todos los streamers
async function showStreamersList() {
    try {
        const response = await fetch('/api/streamers');
        if (response.ok) {
            const streamers = await response.json();
            hideAllForms();

            const tableHTML = `
                <div id="listForm" class="operation-form rpgui-container framed-golden" style="display: block;">
                    <h3>üìã Lista de Streamers</h3>
                    <div class="table-wrapper" style="max-height: 420px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Imagen</th>
                                    <th>Nombre</th>
                                    <th>Juego</th>
                                    <th>Seguidores</th>
                                    <th>Espectadores Promedio</th>
                                </tr>
                            </thead>
                            <tbody id="listStreamersBody">
                                ${streamers.map(streamer => `
                                    <tr>
                                        <td>${streamer.id}</td>
                                        <td>
                                            ${streamer.image_url ?
                                                `<a href="${streamer.image_url}" target="_blank">
                                                    <img src="${streamer.image_url}" alt="${streamer.name}"
                                                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">
                                                </a>` :
                                                '‚ùå Sin imagen'
                                            }
                                        </td>
                                        <td>${streamer.name}</td>
                                        <td>${streamer.game}</td>
                                        <td>${streamer.follower_count.toLocaleString()}</td>
                                        <td>${streamer.avg_viewers.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const formsContainer = document.querySelector('.forms-container');
            const existingList = document.getElementById('listForm');
            if (existingList) existingList.remove();

            formsContainer.insertAdjacentHTML('beforeend', tableHTML);
        } else {
            alert('Error al cargar los streamers');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar los streamers');
    }
}
</script>
{% endblock %}