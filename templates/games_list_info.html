{% extends 'base.html' %}
{% block title %}CRUD de Juegos{% endblock %}

{% block content %}
<style>
.page-layout {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 1em;
    padding: 1em;
    height: calc(100vh - 100px);
    overflow: hidden;
}

.buttons-container {
    height: 100%;
    overflow-y: auto;
}

.crud-buttons {
    position: sticky;
    top: 0;
}

.button-row {
    display: flex;
    flex-direction: column;
    gap: 0.8em;
}

.button-row .rpgui-button {
    width: 100%;
    padding: 0.5em !important;
    min-height: unset !important;
}

.forms-container {
    height: 100%;
    overflow-y: auto;
    padding-right: 1em;
}

.operation-form {
    margin-bottom: 1em;
    padding: 1em;
}

.form-group {
    margin-bottom: 0.8em;
    display: grid;
    grid-template-columns: 150px 1fr;
    align-items: center;
    gap: 0.5em;
}

.form-group label {
    font-size: 0.9em;
}

.form-group input {
    width: 100%;
    padding: 0.4em;
}

.form-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.8em;
    margin-top: 1em;
}

.form-buttons .rpgui-button {
    padding: 0.5em 1em !important;
    min-height: unset !important;
}

h2, h3 {
    text-align: center;
    margin-bottom: 0.8em;
    font-size: 1.1em;
}

.message {
    padding: 0.8em;
    margin-bottom: 1em;
    border-radius: 4px;
}

.success { background-color: rgba(0, 255, 0, 0.1); color: #00ff00; }
.error { background-color: rgba(255, 0, 0, 0.1); color: #ff0000; }

@media (max-width: 768px) {
    .page-layout {
        grid-template-columns: 1fr;
        height: auto;
        overflow: visible;
    }

    .forms-container {
        height: auto;
        overflow: visible;
    }

    .form-group {
        grid-template-columns: 1fr;
    }

    .form-buttons {
        flex-direction: column;
    }

    .form-buttons .rpgui-button {
        width: 100%;
    }
}
</style>

<div class="page-layout">
    <!-- Columna izquierda: Botones -->
    <div class="buttons-container">
        <div class="crud-buttons rpgui-container framed-golden">
            <h2>üéÆ Opciones</h2>
            <div class="button-row">
                <button class="rpgui-button" onclick="showCreateForm()">
                    <span>‚ûï Crear</span>
                </button>
                <button class="rpgui-button" onclick="showDeleteForm()">
                    <span>üóëÔ∏è Eliminar</span>
                </button>
                <button class="rpgui-button" onclick="showUpdateForm()">
                    <span>‚úèÔ∏è Actualizar</span>
                </button>
                <button class="rpgui-button" onclick="location.href='/games'">
                    <span>üìã Listar</span>
                </button>
                <button class="rpgui-button" onclick="showSearchById()">
                    <span>üîç Buscar ID</span>
                </button>
                <button class="rpgui-button" onclick="showSearchByName()">
                    <span>üîé Buscar Nombre</span>
                </button>
                <button class="rpgui-button" onclick="showImportForm()">
                    <span>üì• Importar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Columna derecha: Formularios -->
    <div class="forms-container">
        {% if success_msg %}
        <div class="message success">{{ success_msg }}</div>
        {% endif %}
        {% if error_msg %}
        <div class="message error">{{ error_msg }}</div>
        {% endif %}

        <!-- Formularios aqu√≠ -->
        <!-- Ejemplo del formulario de creaci√≥n (los dem√°s seguir√≠an el mismo patr√≥n) -->
        <div id="createForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>‚ûï Crear Nuevo Juego</h3>
            <form onsubmit="createGame(event)">
                <div class="form-group">
                    <label class="rpgui-label">üé≤ Nombre:</label>
                    <input type="text" id="createGameName" class="rpgui-input" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üìÖ Fecha:</label>
                    <input type="text" 
                           id="createGameDate" 
                           class="rpgui-input" 
                           placeholder="AAAA-MM-DD" 
                           pattern="\d{4}-\d{2}-\d{2}"
                           title="Usa el formato AAAA-MM-DD (ejemplo: 2024-01-01)"
                           oninput="formatearFecha(this)"
                           onblur="validarFecha(this)"
                           required>
                    <span id="fechaError" style="color: #ff6b6b; display: none; font-size: 0.8em; margin-top: 0.3em;">
                        Por favor, ingresa una fecha v√°lida en formato AAAA-MM-DD
                    </span>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">‚åõ Horas:</label>
                    <input type="number" id="createGameHours" class="rpgui-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üë• Espectadores:</label>
                    <input type="number" id="createGamePeakViewers" class="rpgui-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üì∫ Canales:</label>
                    <input type="number" id="createGamePeakChannels" class="rpgui-input" min="0" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">üíæ Guardar</button>
                </div>
            </form>
        </div>

        <!-- Formulario de Eliminaci√≥n -->
        <div id="deleteForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>üóëÔ∏è Eliminar Juego</h3>
            <form onsubmit="deleteGame(event)">
                <div class="form-group">
                    <label class="rpgui-label">üî¢ ID del Juego:</label>
                    <input type="number" id="deleteGameId" class="rpgui-input" required min="1">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">
                        <span>üóëÔ∏è Eliminar</span>
                    </button>
                    <button type="button" class="rpgui-button" onclick="hideAllForms()">
                        <span>‚ùå Cancelar</span>
                    </button>
                </div>
            </form>
        </div>
        <!-- Los dem√°s formularios seguir√≠an el mismo patr√≥n -->
        <!-- ... -->
<!-- Formulario de Actualizaci√≥n -->
<div id="updateForm" class="operation-form rpgui-container framed-golden" style="display: none;">
    <h3>‚úèÔ∏è Actualizar Juego</h3>
    <form onsubmit="updateGame(event)">
        <div class="form-group">
            <label class="rpgui-label">üî¢ ID del Juego:</label>
            <input type="number" id="updateGameId" class="rpgui-input" required min="1">
        </div>
        <div class="form-group">
            <label class="rpgui-label">üé≤ Nombre:</label>
            <input type="text" id="updateGameName" class="rpgui-input" required>
        </div>
<div class="form-group">
    <label class="rpgui-label">üìÖ Fecha:</label>
    <input type="text" id="updateGameDate" class="rpgui-input" 
           placeholder="AAAA-MM-DD" 
           pattern="\d{4}-\d{2}-\d{2}"
           title="Usa el formato AAAA-MM-DD (ejemplo: 2024-01-01)"
           oninput="formatearFecha(this)"
           onblur="validarFecha(this)"
           required>
    <span id="updateFechaError" style="color: #ff6b6b; display: none; font-size: 0.8em; margin-top: 0.3em;">
        Por favor, ingresa una fecha v√°lida en formato AAAA-MM-DD
    </span>
</div>
        <div class="form-group">
            <label class="rpgui-label">‚åõ Horas Vistas:</label>
            <input type="number" id="updateGameHours" class="rpgui-input" min="0" required>
        </div>
        <div class="form-group">
            <label class="rpgui-label">üë• Pico de Espectadores:</label>
            <input type="number" id="updateGamePeakViewers" class="rpgui-input" min="0" required>
        </div>
        <div class="form-group">
            <label class="rpgui-label">üì∫ Pico de Canales:</label>
            <input type="number" id="updateGamePeakChannels" class="rpgui-input" min="0" required>
        </div>
        <div class="form-buttons">
            <button type="submit" class="rpgui-button">
                <span>üíæ Guardar</span>
            </button>
            <button type="button" class="rpgui-button" onclick="hideAllForms()">
                <span>‚ùå Cancelar</span>
            </button>
        </div>
    </form>
</div>
    </div>
</div>

<!-- El script se mantiene igual -->
<script>
async function confirmDelete(gameId) {
    if (confirm('¬øEst√°s seguro de que deseas eliminar este juego?')) {
        try {
            const response = await fetch(`/api/games/${gameId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert('Error al eliminar el juego: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al eliminar el juego');
        }
    }
}

function refreshList() {
    location.reload();
}

function exportToCSV() {
    const table = document.querySelector('table');
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        let row = [], cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length - 1; j++) {
            row.push(cols[j].innerText);
        }
        
        csv.push(row.join(','));
    }

    const csvContent = 'data:text/csv;charset=utf-8,' + csv.join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', 'games_data.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

<style>
/* A√±ade estos estilos para los botones en la tabla */
.actions {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.actions .rpgui-button {
    padding: 5px 10px !important;
    min-height: unset !important;
    font-size: 0.9em;
}
</style>

<script>
// Funci√≥n para dar formato a la fecha mientras se escribe
function formatearFecha(input) {
    // Eliminar cualquier car√°cter que no sea n√∫mero
    let valor = input.value.replace(/\D/g, '');
    
    // Si tenemos 8 o m√°s d√≠gitos, formateamos como AAAA-MM-DD
    if (valor.length >= 8) {
        valor = valor.slice(0, 8); // Limitamos a 8 d√≠gitos
        valor = valor.slice(0, 4) + '-' + valor.slice(4, 6) + '-' + valor.slice(6);
    }
    // Si tenemos 6 d√≠gitos, a√±adimos el primer guion
    else if (valor.length >= 6) {
        valor = valor.slice(0, 4) + '-' + valor.slice(4, 6) + '-' + valor.slice(6);
    }
    // Si tenemos 4 d√≠gitos, a√±adimos el primer guion
    else if (valor.length >= 4) {
        valor = valor.slice(0, 4) + '-' + valor.slice(4);
    }
    
    input.value = valor;
}

// Funci√≥n para validar la fecha
function validarFecha(input) {
    const errorSpanId = input.id === 'updateGameDate' ? 'updateFechaError' : 'fechaError';
    const fechaError = document.getElementById(errorSpanId);
    const valor = input.value;
    const regex = /^(\d{4})-(\d{2})-(\d{2})$/;
    
    if (!regex.test(valor)) {
        fechaError.textContent = 'Formato inv√°lido. Usa AAAA-MM-DD';
        fechaError.style.display = 'block';
        input.setCustomValidity('Formato inv√°lido');
        return false;
    }
    
    const [, a√±o, mes, dia] = valor.match(regex);
    const a√±oNum = parseInt(a√±o);
    const mesNum = parseInt(mes);
    const diaNum = parseInt(dia);
    
    // Validar rango de fechas
    if (a√±oNum < 2000 || a√±oNum > 2025) {
        fechaError.textContent = 'El a√±o debe estar entre 2000 y 2025';
        fechaError.style.display = 'block';
        input.setCustomValidity('A√±o fuera de rango');
        return false;
    }
    
    if (mesNum < 1 || mesNum > 12) {
        fechaError.textContent = 'El mes debe estar entre 01 y 12';
        fechaError.style.display = 'block';
        input.setCustomValidity('Mes inv√°lido');
        return false;
    }
    
    // Validar d√≠as seg√∫n el mes
    const diasEnMes = new Date(a√±oNum, mesNum, 0).getDate();
    if (diaNum < 1 || diaNum > diasEnMes) {
        fechaError.textContent = `El d√≠a debe estar entre 01 y ${diasEnMes} para el mes seleccionado`;
        fechaError.style.display = 'block';
        input.setCustomValidity('D√≠a inv√°lido');
        return false;
    }
    
    fechaError.style.display = 'none';
    input.setCustomValidity('');
    return true;
}

// Modificar la funci√≥n updateGame para incluir la validaci√≥n
async function updateGame(event) {
    event.preventDefault();
    const gameId = document.getElementById('updateGameId').value;
    const gameName = document.getElementById('updateGameName').value;
    const fechaInput = document.getElementById('updateGameDate');
    
    if (!validarFecha(fechaInput)) {
        return;
    }
    
    const gameData = {
        game: gameName,
        date: fechaInput.value,
        hours_watched: parseInt(document.getElementById('updateGameHours').value),
        peak_viewers: parseInt(document.getElementById('updateGamePeakViewers').value),
        peak_channels: parseInt(document.getElementById('updateGamePeakChannels').value)
    };

    try {
        const response = await fetch(`/api/games/${gameId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(gameData)
        });

        if (response.ok) {
            alert(`¬°El juego "${gameName}" con ID ${gameId} ha sido actualizado correctamente!`);
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al actualizar el juego: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el juego');
    }
}

// A√±adir validaci√≥n antes de enviar el formulario
document.querySelector('form').addEventListener('submit', function(event) {
    const fechaInput = document.getElementById('createGameDate');
    if (!validarFecha(fechaInput)) {
        event.preventDefault();
    }
});

// Mant√©n el mismo JavaScript que antes
function hideAllForms() {
    document.querySelectorAll('.operation-form').forEach(form => {
        form.style.display = 'none';
    });
}

function showForm(formId) {
    hideAllForms();
    document.getElementById(formId).style.display = 'block';
}

function showCreateForm() {
    showForm('createForm');
}

function showSearchById() {
    showForm('searchByIdForm');
}

function showSearchByName() {
    showForm('searchByNameForm');
}

function showUpdateForm() {
    showForm('updateForm');
}

function showDeleteForm() {
    showForm('deleteForm');
}

function showImportForm() {
    showForm('importForm');
}

async function createGame(event) {
    event.preventDefault();
    const gameData = {
        game: document.getElementById('createGameName').value,
        date: document.getElementById('createGameDate').value,
        hours_watched: parseInt(document.getElementById('createGameHours').value),
        peak_viewers: parseInt(document.getElementById('createGamePeakViewers').value),
        peak_channels: parseInt(document.getElementById('createGamePeakChannels').value)
    };

    try {
        const response = await fetch('/api/games/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(gameData)
        });

        if (response.ok) {
            alert('¬°Juego creado correctamente!');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al crear el juego: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al crear el juego');
    }
}

async function searchById(event) {
    event.preventDefault();
    const id = document.getElementById('searchGameId').value;
    location.href = `/games/${id}`;
}

async function searchByName(event) {
    event.preventDefault();
    const name = document.getElementById('searchGameName').value;
    location.href = `/games?game_name=${encodeURIComponent(name)}`;
}

// Funci√≥n para mostrar el formulario de actualizaci√≥n
function showUpdateForm() {
    hideAllForms();
    document.getElementById('updateForm').style.display = 'block';
}

async function deleteGame(event) {
    event.preventDefault();
    const gameId = document.getElementById('deleteGameId').value;
    
    if (confirm('¬øEst√°s seguro de que deseas eliminar este juego?')) {
        try {
            const response = await fetch(`/api/games/${gameId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('¬°Juego eliminado correctamente!');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error al eliminar el juego: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al eliminar el juego');
        }
    }
}

async function importGames(event) {
    event.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('importFile');
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/games/import', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert('Juegos importados correctamente');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al importar los juegos: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al importar los juegos');
    }
}
</script>
{% endblock %}