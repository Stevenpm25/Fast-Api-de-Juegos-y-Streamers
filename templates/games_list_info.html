{% extends 'base.html' %}
{% block title %}CRUD de Juegos{% endblock %}

{% block content %}
<style>
.page-layout {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 1em;
    padding: 1em;
    height: calc(100vh - 200px);
    overflow: hidden;
}

.buttons-container {
    height: 100%;
    overflow-y: auto;
}

.crud-buttons {
    position: sticky;
    top: 0;
}

.button-row {
    display: flex;
    flex-direction: column;
    gap: 0.8em;
}

.button-row .rpgui-button {
    width: 100%;
    padding: 0.5em !important;
    min-height: unset !important;
}

.forms-container {
    height: 100%;
    overflow-y: auto;
    padding-right: 1em;
}

.operation-form {
    margin-bottom: 1em;
    padding: 1em;
}

.form-group {
    margin-bottom: 0.8em;
    display: grid;
    grid-template-columns: 150px 1fr;
    align-items: center;
    gap: 0.5em;
}

.form-group label {
    font-size: 0.9em;
}

.form-group input {
    width: 100%;
    padding: 0.4em;
}

.form-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.8em;
    margin-top: 1em;
}

.form-buttons .rpgui-button {
    padding: 0.5em 1em !important;
    min-height: unset !important;
}

h2, h3 {
    text-align: center;
    margin-bottom: 0.8em;
    font-size: 1.1em;
}

.message {
    padding: 0.8em;
    margin-bottom: 1em;
    border-radius: 4px;
}

.success { background-color: rgba(0, 255, 0, 0.1); color: #00ff00; }
.error { background-color: rgba(255, 0, 0, 0.1); color: #ff0000; }

@media (max-width: 768px) {
    .page-layout {
        grid-template-columns: 1fr;
        height: auto;
        overflow: visible;
    }

    .forms-container {
        height: auto;
        overflow: visible;
    }

    .form-group {
        grid-template-columns: 1fr;
    }

    .form-buttons {
        flex-direction: column;
    }

    .form-buttons .rpgui-button {
        width: 100%;
    }
}
</style>

<div class="page-layout" style="display: flex; gap: 2em; align-items: flex-start;">
  <!-- Columna izquierda: Botones -->
  <div class="buttons-container">
    <div class="crud-buttons rpgui-container framed-golden">
      <h2>üéÆ Opciones</h2>
      <div class="button-row">
        <button class="rpgui-button" onclick="showCreateForm()"><span>‚ûï Crear</span></button>
        <button class="rpgui-button" onclick="showDeleteForm()"><span>üóëÔ∏è Eliminar</span></button>
        <button class="rpgui-button" onclick="showUpdateForm()"><span>‚úèÔ∏è Actualizar</span></button>
        <button class="rpgui-button" onclick="showSearchById()"><span>üîç Buscar ID</span></button>
        <button class="rpgui-button" onclick="showSearchByName()"><span>üîé Buscar Nombre</span></button>
        <button class="rpgui-button" onclick="showImportForm()"><span>üì• Importar</span></button>
        <button class="rpgui-button" onclick="showDeletedGames()"><span>üóëÔ∏èüëÄ Mostrar Eliminados</span></button>
        <button class="rpgui-button" onclick="showPartialUpdateForm()"><span>üîß Actualizaci√≥n Parcial</span></button>
        <button class="rpgui-button" onclick="showRestoreForm()"><span>‚ôªÔ∏è Recuperar Eliminado</span></button>
        <button class="rpgui-button" onclick="showGamesList()"><span>üìã Listar</span></button>

      </div>
    </div>
  </div>

   <!-- Columna derecha: Formularios y secci√≥n de info -->
 <!-- Columna derecha: Formularios e Informaci√≥n -->
  <div style="display: flex; flex-direction: column; gap: 2em; flex: 1;">
    <div class="forms-container">

      {% if success_msg %}
      <div class="message success">{{ success_msg }}</div>
      {% endif %}
      {% if error_msg %}
      <div class="message error">{{ error_msg }}</div>
      {% endif %}


        <!-- Formularios aqu√≠ -->
        <!-- Ejemplo del formulario de creaci√≥n (los dem√°s seguir√≠an el mismo patr√≥n) -->
        <div id="createForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>‚ûï Crear Nuevo Juego</h3>
            <form onsubmit="createGame(event)">
                <div class="form-group">
                    <label class="rpgui-label">üé≤ Nombre:</label>
                    <input type="text" id="createGameName" class="rpgui-input" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üìÖ Fecha:</label>
                    <input type="text"
                           id="createGameDate"
                           class="rpgui-input"
                           placeholder="AAAA-MM-DD"
                           pattern="\d{4}-\d{2}-\d{2}"
                           title="Usa el formato AAAA-MM-DD (ejemplo: 2024-01-01)"
                           oninput="formatearFecha(this)"
                           onblur="validarFecha(this)"
                           required>
                    <span id="fechaError" style="color: #ff6b6b; display: none; font-size: 0.8em; margin-top: 0.3em;">
                        Por favor, ingresa una fecha v√°lida en formato AAAA-MM-DD
                    </span>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">‚åõ Horas:</label>
                    <input type="number" id="createGameHours" class="rpgui-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üë• Espectadores:</label>
                    <input type="number" id="createGamePeakViewers" class="rpgui-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üì∫ Canales:</label>
                    <input type="number" id="createGamePeakChannels" class="rpgui-input" min="0" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">üíæ Guardar</button>
                </div>
            </form>
        </div>

        <!-- Formulario de Eliminaci√≥n -->
        <div id="deleteForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>üóëÔ∏è Eliminar Juego</h3>
            <form onsubmit="deleteGame(event)">
                <div class="form-group">
                    <label class="rpgui-label">üî¢ ID del Juego:</label>
                    <input type="number" id="deleteGameId" class="rpgui-input" required min="1">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">
                        <span>üóëÔ∏è Eliminar</span>
                    </button>
                    <button type="button" class="rpgui-button" onclick="hideAllForms()">
                        <span>‚ùå Cancelar</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Formulario de Recuperaci√≥n de Juegos Eliminados -->
        <div id="restoreForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>‚ôªÔ∏è Recuperar Juego Eliminado</h3>
            <form onsubmit="restoreGame(event)">
                <div class="form-group">
                    <label class="rpgui-label">üî¢ ID del Juego:</label>
                    <input type="number" id="restoreGameId" class="rpgui-input" required min="1">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">
                        <span>‚ôªÔ∏è Recuperar</span>
                    </button>
                    <button type="button" class="rpgui-button" onclick="hideAllForms()">
                        <span>‚ùå Cancelar</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Formulario de B√∫squeda por ID -->
        <div id="searchByIdForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>üîç Buscar Juego por ID</h3>
            <form onsubmit="buscarPorId(event)">
                <div class="form-group">
                    <label class="rpgui-label">üé≤ ID del Juego:</label>
                    <input type="number"
                           id="buscarGameId"
                           class="rpgui-input"
                           min="1"
                           required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">
                        <span>üîç Buscar</span>
                    </button>
                    <button type="button" class="rpgui-button" onclick="hideAllForms()">
                        <span>‚ùå Cancelar</span>
                    </button>
                </div>
            </form>

            <!-- Contenedor para mostrar el resultado -->
            <div id="searchIdResult" style="display: none; margin-top: 20px;">
                <h3>üìã Resultado:</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Fecha</th>
                                <th>Horas Vistas</th>
                                <th>Pico Espectadores</th>
                                <th>Pico Canales</th>
                            </tr>
                        </thead>
                        <tbody id="searchIdResultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Formulario de B√∫squeda por Nombre -->
        <div id="searchByNameForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>üîé Buscar Juego por Nombre</h3>
            <form onsubmit="buscarPorNombre(event)">
                <div class="form-group">
                    <label class="rpgui-label">üé≤ Nombre del Juego:</label>
                    <input type="text"
                           id="buscarGameName"
                           class="rpgui-input"
                           required
                           minlength="1"
                           placeholder="Ingresa al menos un car√°cter">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">
                        <span>üîé Buscar</span>
                    </button>
                    <button type="button" class="rpgui-button" onclick="hideAllForms()">
                        <span>‚ùå Cancelar</span>
                    </button>
                </div>
            </form>

            <!-- Contenedor para mostrar los resultados -->
            <div id="searchNameResult" style="display: none;">
                <h3>üìã Resultados:</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Fecha</th>
                                <th>Horas Vistas</th>
                                <th>Pico Espectadores</th>
                                <th>Pico Canales</th>
                            </tr>
                        </thead>
                        <tbody id="searchNameResultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Formulario de Importaci√≥n de CSV -->
        <div id="importForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>üì• Importar Juegos desde CSV</h3>
            <form onsubmit="importGames(event)">
                <div class="form-group">
                    <label class="rpgui-label">üìÅ Archivo CSV:</label>
                    <input type="file"
                           id="importFile"
                           class="rpgui-input"
                           accept=".csv"
                           required>
                    <p style="font-size: 0.8em; margin-top: 0.5em; color: #aaa;">
                        El archivo CSV debe contener las columnas: date, game, hours_watched, peak_viewers, peak_channels
                    </p>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">
                        <span>üì• Importar</span>
                    </button>
                    <button type="button" class="rpgui-button" onclick="hideAllForms()">
                        <span>‚ùå Cancelar</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Formulario de Actualizaci√≥n Parcial -->
        <div id="partialUpdateForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>‚úèÔ∏èüîß Actualizaci√≥n Parcial</h3>
            <form onsubmit="partialUpdateGame(event)">
                <div class="form-group">
                    <label class="rpgui-label">üî¢ ID del Juego:</label>
                    <input type="number" id="partialUpdateGameId" class="rpgui-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üìå Campo a actualizar:</label>
                    <select id="partialUpdateField" class="rpgui-input" required>
                        <option value="">Selecciona un campo</option>
                        <option value="game">Nombre</option>
                        <option value="date">Fecha</option>
                        <option value="hours_watched">Horas Vistas</option>
                        <option value="peak_viewers">Pico Espectadores</option>
                        <option value="peak_channels">Pico Canales</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üÜï Nuevo valor:</label>
                    <input type="text" id="partialUpdateValue" class="rpgui-input" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">
                        <span>üíæ Guardar</span>
                    </button>
                    <button type="button" class="rpgui-button" onclick="hideAllForms()">
                        <span>‚ùå Cancelar</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Formulario de Actualizaci√≥n -->
        <div id="updateForm" class="operation-form rpgui-container framed-golden" style="display: none;">
            <h3>‚úèÔ∏è Actualizar Juego</h3>
            <form onsubmit="updateGame(event)">
                <div class="form-group">
                    <label class="rpgui-label">üî¢ ID del Juego:</label>
                    <input type="number" id="updateGameId" class="rpgui-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üé≤ Nombre:</label>
                    <input type="text" id="updateGameName" class="rpgui-input" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üìÖ Fecha:</label>
                    <input type="text" id="updateGameDate" class="rpgui-input"
                           placeholder="AAAA-MM-DD"
                           pattern="\d{4}-\d{2}-\d{2}"
                           title="Usa el formato AAAA-MM-DD (ejemplo: 2024-01-01)"
                           oninput="formatearFecha(this)"
                           onblur="validarFecha(this)"
                           required>
                    <span id="updateFechaError" style="color: #ff6b6b; display: none; font-size: 0.8em; margin-top: 0.3em;">
                        Por favor, ingresa una fecha v√°lida en formato AAAA-MM-DD
                    </span>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">‚åõ Horas Vistas:</label>
                    <input type="number" id="updateGameHours" class="rpgui-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üë• Pico de Espectadores:</label>
                    <input type="number" id="updateGamePeakViewers" class="rpgui-input" min="0" required>
                </div>
                <div class="form-group">
                    <label class="rpgui-label">üì∫ Pico de Canales:</label>
                    <input type="number" id="updateGamePeakChannels" class="rpgui-input" min="0" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="rpgui-button">
                        <span>üíæ Guardar</span>
                    </button>
                    <button type="button" class="rpgui-button" onclick="hideAllForms()">
                        <span>‚ùå Cancelar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>


<div class="forms-container">

  {% include 'info_games.html' %}
</div>

<script>
async function buscarPorNombre(event) {
    event.preventDefault();
    const nombre = document.getElementById("buscarGameName").value;

    try {
        const response = await fetch(`/api/games/search?game_name=${encodeURIComponent(nombre)}`);
        const tbody = document.getElementById("searchNameResultsBody");
        tbody.innerHTML = ''; // Limpiar resultados anteriores

        if (response.ok) {
            const games = await response.json();

            if (games.length > 0) {
                games.forEach(game => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${game.id}</td>
                        <td>${game.game}</td>
                        <td>${game.date}</td>
                        <td>${game.hours_watched.toLocaleString()}</td>
                        <td>${game.peak_viewers.toLocaleString()}</td>
                        <td>${game.peak_channels.toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center;">
                            No se encontraron juegos con el nombre "${nombre}"
                        </td>
                    </tr>`;
            }
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center;">
                        Nombre no encontrado: "${nombre}"
                    </td>
                </tr>`;
        }

        document.getElementById("searchNameResult").style.display = "block";
    } catch (error) {
        console.error(error);
        const tbody = document.getElementById("searchNameResultsBody");
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center;">
                    Nombre no encontrado: "${nombre}"
                </td>
            </tr>`;
        document.getElementById("searchNameResult").style.display = "block";
    }
}
</script>     <!-- Los dem√°s formularios seguir√≠an el mismo patr√≥n -->

<style>
/* A√±ade estos estilos para los botones en la tabla */
.actions {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.actions .rpgui-button {
    padding: 5px 10px !important;
    min-height: unset !important;
    font-size: 0.9em;
}
</style>
<script>
function showSearchByName() {
    hideAllForms();
    document.getElementById('searchByNameForm').style.display = 'block';
}
function showImportForm() {
    hideAllForms();
    document.getElementById('importForm').style.display = 'block';
    // Limpiar el campo de archivo al mostrar el formulario
    document.getElementById('importFile').value = '';
}
async function buscarPorNombre(event) {
    event.preventDefault();
    const nombre = document.getElementById("buscarGameName").value;

    try {
        const response = await fetch(`/api/games/search?game_name=${encodeURIComponent(nombre)}`);
        const tbody = document.getElementById("searchNameResultsBody");
        tbody.innerHTML = ''; // Limpiar resultados anteriores

        if (response.ok) {
            const games = await response.json();

            if (games.length > 0) {
                games.forEach(game => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${game.id}</td>
                        <td>${game.game}</td>
                        <td>${game.date}</td>
                        <td>${game.hours_watched.toLocaleString()}</td>
                        <td>${game.peak_viewers.toLocaleString()}</td>
                        <td>${game.peak_channels.toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center;">
                            No se encontraron juegos con el nombre "${nombre}"
                        </td>
                    </tr>`;
            }
        } else {
            throw new Error('Error en la b√∫squeda');
        }

        document.getElementById("searchNameResult").style.display = "block";
    } catch (error) {
        console.error(error);
        alert("Hubo un error al realizar la b√∫squeda");
    }
}
</script>
<script>
// Funci√≥n para dar formato a la fecha mientras se escribe
function formatearFecha(input) {
    // Eliminar cualquier car√°cter que no sea n√∫mero
    let valor = input.value.replace(/\D/g, '');

    // Si tenemos 8 o m√°s d√≠gitos, formateamos como AAAA-MM-DD
    if (valor.length >= 8) {
        valor = valor.slice(0, 8); // Limitamos a 8 d√≠gitos
        valor = valor.slice(0, 4) + '-' + valor.slice(4, 6) + '-' + valor.slice(6);
    }
    // Si tenemos 6 d√≠gitos, a√±adimos el primer guion
    else if (valor.length >= 6) {
        valor = valor.slice(0, 4) + '-' + valor.slice(4, 6) + '-' + valor.slice(6);
    }
    // Si tenemos 4 d√≠gitos, a√±adimos el primer guion
    else if (valor.length >= 4) {
        valor = valor.slice(0, 4) + '-' + valor.slice(4);
    }

    input.value = valor;
}

// Funci√≥n para validar la fecha
function validarFecha(input) {
    const errorSpanId = input.id === 'updateGameDate' ? 'updateFechaError' : 'fechaError';
    const fechaError = document.getElementById(errorSpanId);
    const valor = input.value;
    const regex = /^(\d{4})-(\d{2})-(\d{2})$/;

    if (!regex.test(valor)) {
        fechaError.textContent = 'Formato inv√°lido. Usa AAAA-MM-DD';
        fechaError.style.display = 'block';
        input.setCustomValidity('Formato inv√°lido');
        return false;
    }

    const [, a√±o, mes, dia] = valor.match(regex);
    const a√±oNum = parseInt(a√±o);
    const mesNum = parseInt(mes);
    const diaNum = parseInt(dia);

    // Validar rango de fechas
    if (a√±oNum < 2000 || a√±oNum > 2025) {
        fechaError.textContent = 'El a√±o debe estar entre 2000 y 2025';
        fechaError.style.display = 'block';
        input.setCustomValidity('A√±o fuera de rango');
        return false;
    }

    if (mesNum < 1 || mesNum > 12) {
        fechaError.textContent = 'El mes debe estar entre 01 y 12';
        fechaError.style.display = 'block';
        input.setCustomValidity('Mes inv√°lido');
        return false;
    }

    // Validar d√≠as seg√∫n el mes
    const diasEnMes = new Date(a√±oNum, mesNum, 0).getDate();
    if (diaNum < 1 || diaNum > diasEnMes) {
        fechaError.textContent = `El d√≠a debe estar entre 01 y ${diasEnMes} para el mes seleccionado`;
        fechaError.style.display = 'block';
        input.setCustomValidity('D√≠a inv√°lido');
        return false;
    }

    fechaError.style.display = 'none';
    input.setCustomValidity('');
    return true;
}

// Modificar la funci√≥n updateGame para incluir la validaci√≥n
async function updateGame(event) {
    event.preventDefault();
    const gameId = document.getElementById('updateGameId').value;
    const gameName = document.getElementById('updateGameName').value;
    const fechaInput = document.getElementById('updateGameDate');

    if (!validarFecha(fechaInput)) {
        return;
    }

    const gameData = {
        game: gameName,
        date: fechaInput.value,
        hours_watched: parseInt(document.getElementById('updateGameHours').value),
        peak_viewers: parseInt(document.getElementById('updateGamePeakViewers').value),
        peak_channels: parseInt(document.getElementById('updateGamePeakChannels').value)
    };

    try {
        const response = await fetch(`/api/games/${gameId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(gameData)
        });

        if (response.ok) {
            alert(`¬°El juego "${gameName}" con ID ${gameId} ha sido actualizado correctamente!`);
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al actualizar el juego: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el juego');
    }
}

// A√±adir validaci√≥n antes de enviar el formulario
document.querySelector('form').addEventListener('submit', function(event) {
    const fechaInput = document.getElementById('createGameDate');
    if (!validarFecha(fechaInput)) {
        event.preventDefault();
    }
});

// A√±ade esta funci√≥n
function showGamesList() {
    hideAllForms();  // Primero ocultamos todos los formularios
    listGames();     // Luego llamamos a listGames para mostrar la lista
}

// Modifica la funci√≥n hideAllForms existente
function hideAllForms() {
    const forms = [
        'createForm',
        'deleteForm',
        'updateForm',
        'searchByIdForm',
        'searchByNameForm',
        'importForm',
        'listForm',
        'deletedGamesForm',
        'partialUpdateForm',
        'restoreForm'
    ];

    forms.forEach(formId => {
        const form = document.getElementById(formId);
        if (form) {
            form.style.display = 'none';
            if (formId === 'listForm' || formId === 'deletedGamesForm') {
                form.remove();
            }
        }
    });

    // Ocultar secci√≥n de informaci√≥n
    const infoSection = document.getElementById('info-crud-wrapper');
    if (infoSection) {
        infoSection.style.display = 'none';
    }
}

function showForm(formId) {
    hideAllForms();
    document.getElementById(formId).style.display = 'block';
}

function showCreateForm() {
    showForm('createForm');
}

function showSearchById() {
    showForm('searchByIdForm');
}

function showSearchByName() {
    showForm('searchByNameForm');
}

function showUpdateForm() {
    showForm('updateForm');
}

function showDeleteForm() {
    showForm('deleteForm');
}

function showImportForm() {
    showForm('importForm');
}
function showPartialUpdateForm() {
    showForm('partialUpdateForm');
}

function showRestoreForm() {
    showForm('restoreForm');
}

async function createGame(event) {
    event.preventDefault();
    const gameData = {
        game: document.getElementById('createGameName').value,
        date: document.getElementById('createGameDate').value,
        hours_watched: parseInt(document.getElementById('createGameHours').value),
        peak_viewers: parseInt(document.getElementById('createGamePeakViewers').value),
        peak_channels: parseInt(document.getElementById('createGamePeakChannels').value)
    };

    try {
        const response = await fetch('/api/games/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(gameData)
        });

        if (response.ok) {
            alert('¬°Juego creado correctamente!');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al crear el juego: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al crear el juego');
    }
}

async function searchByName(event) {
    event.preventDefault();
    const name = document.getElementById('searchGameName').value;
    location.href = `/games?game_name=${encodeURIComponent(name)}`;
}

// Funci√≥n para mostrar el formulario de actualizaci√≥n
function showUpdateForm() {
    hideAllForms();
    document.getElementById('updateForm').style.display = 'block';
}

async function deleteGame(event) {
    event.preventDefault();
    const gameId = document.getElementById('deleteGameId').value;

    if (confirm('¬øEst√°s seguro de que deseas eliminar este juego?')) {
        try {
            const response = await fetch(`/api/games/${gameId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('¬°Juego eliminado correctamente!');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error al eliminar el juego: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al eliminar el juego');
        }
    }
}

async function restoreGame(event) {
    event.preventDefault();
    const gameId = document.getElementById('restoreGameId').value;

    if (confirm('¬øEst√°s seguro de que deseas recuperar este juego eliminado?')) {
        try {
            const response = await fetch(`/api/games/recover/${gameId}`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('¬°Juego recuperado correctamente!');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error al recuperar el juego: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al recuperar el juego');
        }
    }
}

async function buscarPorId(event) {
    event.preventDefault();
    const id = document.getElementById("buscarGameId").value;

    try {
        const response = await fetch(`/api/games/${id}`);
        const tbody = document.getElementById("searchIdResultsBody");
        tbody.innerHTML = ''; // Limpiar resultados anteriores

        if (response.ok) {
            const game = await response.json();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${game.id}</td>
                <td>${game.game}</td>
                <td>${game.date}</td>
                <td>${game.hours_watched.toLocaleString()}</td>
                <td>${game.peak_viewers.toLocaleString()}</td>
                <td>${game.peak_channels.toLocaleString()}</td>
            `;
            tbody.appendChild(row);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center;">
                        No se encontr√≥ ning√∫n juego con el ID ${id}
                    </td>
                </tr>`;
        }

        document.getElementById("searchIdResult").style.display = "block";
    } catch (error) {
        console.error(error);
        alert("Hubo un error al realizar la b√∫squeda");
    }
}

function showSearchById() {
    hideAllForms();
    // Mostrar el formulario
    document.getElementById('searchByIdForm').style.display = 'block';

    // Limpiar el campo de entrada
    document.getElementById('buscarGameId').value = '';

    // Limpiar los resultados previos
    const tbody = document.getElementById("searchIdResultsBody");
    if (tbody) {
        tbody.innerHTML = '';
    }

    // Ocultar la secci√≥n de resultados
    const searchResult = document.getElementById("searchIdResult");
    if (searchResult) {
        searchResult.style.display = 'none';
    }
}

function showSearchByName() {
    hideAllForms();

    // Mostrar el formulario
    document.getElementById('searchByNameForm').style.display = 'block';

    // Limpiar el campo de b√∫squeda
    document.getElementById('buscarGameName').value = '';

    // Ocultar y limpiar los resultados anteriores
    const searchResult = document.getElementById('searchNameResult');
    if (searchResult) {
        searchResult.style.display = 'none';
    }

    const tbody = document.getElementById('searchNameResultsBody');
    if (tbody) {
        tbody.innerHTML = '';
    }
}
async function importGames(event) {
    event.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('importFile');
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/games/import', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert('Juegos importados correctamente');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error al importar los juegos: ' + error.detail);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al importar los juegos');
    }
}
</script>

<script>
// Agregar esta funci√≥n al script existente
async function listGames() {
    try {
        const response = await fetch('/api/games');
        if (response.ok) {
            const games = await response.json();
            // Ocultar todos los formularios
            hideAllForms();

            // Crear una tabla din√°mica
            let tableHTML = `
                <div id="listForm" class="operation-form rpgui-container framed-golden">
                    <h3>üìã Lista de Juegos</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Fecha</th>
                                    <th>Horas Vistas</th>
                                    <th>Pico Espectadores</th>
                                    <th>Pico Canales</th>
                                </tr>
                            </thead>
                            <tbody>`;

            games.forEach(game => {
                tableHTML += `
                    <tr>
                        <td>${game.id}</td>
                        <td>${game.game}</td>
                        <td>${game.date}</td>
                        <td>${game.hours_watched.toLocaleString()}</td>
                        <td>${game.peak_viewers.toLocaleString()}</td>
                        <td>${game.peak_channels.toLocaleString()}</td>
                    </tr>`;
            });

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>`;

            // Insertar la tabla en el contenedor de formularios
            const formsContainer = document.querySelector('.forms-container');
            const existingList = document.getElementById('listForm');
            if (existingList) {
                existingList.remove();
            }
            formsContainer.insertAdjacentHTML('beforeend', tableHTML);

            // Mostrar la tabla
            document.getElementById('listForm').style.display = 'block';

        } else {
            alert('Error al cargar los juegos');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar los juegos');
    }
// Funci√≥n que resalta y baja hacia la info del CRUD si se quiere
function showInfoGames() {
  hideAllForms();
  const infoSection = document.getElementById('info-crud');
  if (infoSection) {
    infoSection.scrollIntoView({ behavior: 'smooth' });
    infoSection.classList.remove('highlight-animation');
    void infoSection.offsetWidth;
    infoSection.classList.add('highlight-animation');
  }
}
}
</script>

<style>
.table-container {
    overflow-x: auto;
    margin-top: 1em;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 0.5em;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

th {
    background-color: rgba(0, 0, 0, 0.2);
}

tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
}
</style>
<!-- Agrega esta funci√≥n JavaScript al final del archivo, dentro de las etiquetas <script> existentes -->
<script>
async function showGamesList() {
    try {
        const response = await fetch('/api/games');
        if (response.ok) {
            const games = await response.json();
            hideAllForms();

            const tableHTML = `
                <div id="listForm" class="operation-form rpgui-container framed-golden">
                    <h3>üìã Lista de Juegos</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Fecha</th>
                                    <th>Horas Vistas</th>
                                    <th>Pico Espectadores</th>
                                    <th>Pico Canales</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${games.map(game => `
                                    <tr>
                                        <td>${game.id}</td>
                                        <td>${game.game}</td>
                                        <td>${game.date}</td>
                                        <td>${game.hours_watched.toLocaleString()}</td>
                                        <td>${game.peak_viewers.toLocaleString()}</td>
                                        <td>${game.peak_channels.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const formsContainer = document.querySelector('.forms-container');
            const existingList = document.getElementById('listForm');
            if (existingList) {
                existingList.remove();
            }
            formsContainer.insertAdjacentHTML('beforeend', tableHTML);
            document.getElementById('listForm').style.display = 'block';
        } else {
            alert('Error al cargar los juegos');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar los juegos');
    }
}

// Elimina todas las definiciones anteriores de partialUpdateGame
// y reempl√°zalas solo con esta versi√≥n corregida:

async function partialUpdateGame(event) {
    event.preventDefault();

    // Obtener valores del formulario
    const gameId = document.getElementById('partialUpdateGameId').value;
    const field = document.getElementById('partialUpdateField').value;
    let value = document.getElementById('partialUpdateValue').value;

    // Validaciones b√°sicas
    if (!gameId || isNaN(gameId) || gameId < 1) {
        alert('Por favor ingresa un ID de juego v√°lido (n√∫mero mayor a 0)');
        return;
    }

    if (!field) {
        alert('Por favor selecciona un campo a actualizar');
        return;
    }

    if (!value) {
        alert('Por favor ingresa un valor para actualizar');
        return;
    }

    // Convertir valores num√©ricos
    if (field === 'hours_watched' || field === 'peak_viewers' || field === 'peak_channels') {
        value = parseInt(value);
        if (isNaN(value) || value < 0) {
            alert('Por favor ingresa un n√∫mero v√°lido (mayor o igual a 0)');
            return;
        }
    }

    // Validar fecha (corregido)
    if (field === 'date') {
        // Usamos el mismo m√©todo de validaci√≥n que en otros formularios
        const fechaInput = document.createElement('input');
        fechaInput.value = value;
        fechaInput.id = 'tempDateInput';

        if (!validarFecha(fechaInput)) {
            alert('Por favor ingresa una fecha v√°lida en formato AAAA-MM-DD');
            return;
        }
    }

    // Validar nombre (al menos 2 caracteres)
    if (field === 'game' && value.length < 2) {
        alert('El nombre del juego debe tener al menos 2 caracteres');
        return;
    }

    try {
        // Mostrar mensaje de carga
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span>‚åõ Procesando...</span>';
        submitBtn.disabled = true;

        // Depuraci√≥n: mostrar datos que se enviar√°n
        console.log("Enviando:", {
            field: field,
            value: value
        });

        const response = await fetch(`/api/games/partial-update/${gameId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                field: field,
                value: value
            })
        });

        // Restaurar bot√≥n
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

        // Depuraci√≥n: mostrar respuesta
        console.log("Respuesta:", response);

        if (response.ok) {
            alert(`¬°Campo ${field} del juego con ID ${gameId} actualizado correctamente!`);
            // Limpiar el formulario
            document.getElementById('partialUpdateGameId').value = '';
            document.getElementById('partialUpdateField').value = '';
            document.getElementById('partialUpdateValue').value = '';
            // Recargar la p√°gina para ver cambios
            location.reload();
        } else {
            const error = await response.text();
            alert('Error al actualizar: ' + error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error de conexi√≥n: ' + error.message);
        // Restaurar bot√≥n en caso de error
        const submitBtn = event.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<span>üíæ Guardar</span>';
            submitBtn.disabled = false;
        }
    }
}

// Aseg√∫rate de tener solo UNA definici√≥n de showPartialUpdateForm:
function showPartialUpdateForm() {
    hideAllForms();
    document.getElementById('partialUpdateForm').style.display = 'block';
    // Limpiar campos
    document.getElementById('partialUpdateGameId').value = '';
    document.getElementById('partialUpdateField').value = '';
    document.getElementById('partialUpdateValue').value = '';
}

</script>

<!-- A√±ade estos estilos espec√≠ficos -->
<style>
.table-wrapper {
    max-height: 400px;  /* Altura m√°xima fija */
    overflow-y: auto;   /* Scroll vertical */
    margin: 1em 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.table-container {
    width: 100%;
}

.table-container table {
    width: 100%;
    border-collapse: collapse;
}

.table-container th {
    position: sticky;
    top: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 1;
    padding: 10px;
    text-align: left;
}

.table-container td {
    padding: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.table-container tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

/* Estilo para la barra de desplazamiento */
.table-wrapper::-webkit-scrollbar {
    width: 12px;
}

.table-wrapper::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
}

.table-wrapper::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    border: 3px solid rgba(0, 0, 0, 0.3);
}

.table-wrapper::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.3);
}
</style>
<!-- Script para la funcionalidad de recuperar juegos eliminados -->
<script src="/static/js/restore_game.js"></script>
{% endblock %}
<style>
/* Aseg√∫rate de que estos estilos est√©n presentes y no sean sobrescritos */
.page-layout {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 1em;
    padding: 1em;
    height: calc(100vh - 100px);
    overflow: hidden;
}

.forms-container {
    height: 100%;
    overflow-y: auto;
    padding-right: 1em;
}

/* Nuevos estilos para la tabla */
.table-container {
    height: 100%;
    overflow: hidden;
}

#listForm {
    height: calc(100vh - 150px);
    display: flex;
    flex-direction: column;
}

.table-wrapper {
    flex: 1;
    overflow-y: auto;
    margin-top: 1em;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    position: sticky;
    top: 0;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 1;
}
</style>

<script>
async function showDeletedGames() {
    try {
        const response = await fetch('/api/games/deleted');
        if (response.ok) {
            const deletedGames = await response.json();
            hideAllForms();

            if (deletedGames.length === 0) {
                alert('No hay juegos eliminados para mostrar');
                return;
            }

            const tableHTML = `
                <div id="deletedGamesForm" class="operation-form rpgui-container framed-golden">
                    <h3>üóëÔ∏èüëÄ Juegos Eliminados</h3>
                    <div class="table-wrapper rpgui-container framed">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Fecha</th>
                                    <th>Horas Vistas</th>
                                    <th>Pico Espectadores</th>
                                    <th>Pico Canales</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${deletedGames.map(game => `
                                    <tr>
                                        <td>${game.id}</td>
                                        <td>${game.game}</td>
                                        <td>${game.date}</td>
                                        <td>${parseInt(game.hours_watched).toLocaleString()}</td>
                                        <td>${parseInt(game.peak_viewers).toLocaleString()}</td>
                                        <td>${parseInt(game.peak_channels).toLocaleString()}</td>
                                        <td>
                                            <button class="rpgui-button" onclick="recoverGame(${game.id})">
                                                <span>‚ôªÔ∏è Recuperar</span>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const formsContainer = document.querySelector('.forms-container');
            const existingList = document.getElementById('deletedGamesForm');
            if (existingList) {
                existingList.remove();
            }
            formsContainer.insertAdjacentHTML('beforeend', tableHTML);
            document.getElementById('deletedGamesForm').style.display = 'block';
        } else {
            alert('Error al cargar los juegos eliminados');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar los juegos eliminados');
    }
}

async function recoverGame(gameId) {
    if (confirm(`¬øEst√°s seguro de que deseas recuperar el juego con ID ${gameId}?`)) {
        try {
            const response = await fetch(`/api/games/recover/${gameId}`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('¬°Juego recuperado correctamente!');
                location.reload();
            } else {
                const error = await response.json();
                alert('Error al recuperar el juego: ' + error.detail);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al recuperar el juego');
        }
    }
}
</script>
